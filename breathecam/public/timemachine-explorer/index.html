<!doctype html>
  <html lang="en">
    <head>
      <meta charset="utf-8">
      <title></title>

      <link href="css/timelapse.css" rel="stylesheet" type="text/css"/>
      <link href="css/snaplapse.css" rel="stylesheet" type="text/css"/>
      <link href="css/jquery-ui/smoothness/jquery-ui.custom.css" rel="stylesheet" type="text/css"/>
      <link href="css/player.css" rel="stylesheet" type="text/css"/>
      <link href="css/visualizer.css" rel="stylesheet" type="text/css"/>
      <link href="css/annotator.css" rel="stylesheet" type="text/css"/>

      <script src="js/jquery/jquery.min.js" type="text/javascript"></script>
      <script src="js/jquery/jquery-ui.custom.min.js" type="text/javascript"></script>
      <script src="js/jquery/plugins/mouse/jquery.mousewheel.min.js" type="text/javascript"></script>
      <script src="js/jquery/plugins/carousel/jcarousellite.min.js" type="text/javascript"></script>
      <script src="js/kinetic/kinetic.min.js" type="text/javascript"></script>
      <script src="js/org/gigapan/util.js" type="text/javascript"></script>
      <script src="js/org/gigapan/timelapse/videoset.js" type="text/javascript"></script>
      <script src="js/org/gigapan/timelapse/timelapse.js" type="text/javascript"></script>
      <script src="js/Math.uuid.js" type="text/javascript"></script>
      <script src="js/org/gigapan/timelapse/snaplapse.js" type="text/javascript"></script>
      <script src="js/org/gigapan/timelapse/snaplapseViewer.js" type="text/javascript"></script>
      <script src="js/org/gigapan/timelapse/mercator.js" type="text/javascript"></script>
      <script src="js/org/gigapan/timelapse/visualizer.js" type="text/javascript"></script>
      <script src="js/org/gigapan/timelapse/annotator.js" type="text/javascript"></script>
      <script src="js/org/gigapan/timelapse/defaultUI.js" type="text/javascript"></script>
      <script src="js/org/gigapan/timelapse/urlEncoder.js" type="text/javascript"></script>
      <script src="js/org/gigapan/timelapse/crossdomain_api.js" type="text/javascript"></script>
      <script src="template_includes.js" type="text/javascript"></script>

      <style>
        #datepicker { font-size: 10px;}
        #datepicker .ui-state-default { background: white; }
        #datepicker .date-highlight a { background: rgb(240, 240, 240); }
        #datepicker .ui-state-active { border: 1px solid #000000; }
        .ui-datepicker-today a.ui-state-highlight {
          border-color: #d3d3d3;
          color: #555555;
        }
      </style>


      <script type="text/javascript">
        jQuery.support.cors = true;
        var breatheCamJSON = {};
        var initialDataset;

        function tm_init() {

          var viewerOptions = {
            url: initialDataset,
            disableTourLooping: true,
            mediaType: ".mp4",
            showFullScreenBtn: false
          };

          timelapse = new org.gigapan.timelapse.Timelapse("player1", viewerOptions);
        }

        function onTimeMachinePlayerReady(viewerDivId) { }

        function unpackVars(str) {
          var keyvals = str.split('&');
          var vars = {};

          if (keyvals.length == 1 && keyvals[0] == "") return null;

          for (var i = 0; i < keyvals.length; i++) {
            var keyval = keyvals[i].split('=');
            vars[keyval[0]] = keyval[1];
          }
          return vars;
        }

        function highlightDays(date) {
          date = $.datepicker.formatDate('yy-mm-dd', date);
          if (breatheCamJSON.datasets[date])
            return [true, 'date-highlight'];
          else
            return [false, ''];
        }

        function selectDay(dateText, dateElem) {
          var date = $.datepicker.formatDate('yy-mm-dd', new Date(dateText));
          var path = breatheCamJSON.datasets[date];
          if (typeof(timelapse) !== "undefined" && timelapse && path)
            timelapse.loadTimelapse(path);
        }

        $(function() {
          $.ajax({
            dataType: 'json',
            url: "http://g7.gigapan.org/timemachines/breathecam/heinz/breathecam.json",
            success: function(data) {
              if (data) {
                breatheCamJSON = data;

                initialDataset = breatheCamJSON.latest.path;
                var startingDate = breatheCamJSON.latest.date;

                var hash = window.location.hash.slice(1);
                var hashVars = unpackVars(hash);

                if (hashVars && hashVars.d) {
                  var startingDate = hashVars.d
                  initialDataset = initialDataset.replace(/\d\d\d\d-\d\d-\d\d/, hashVars.d);
                }

                tm_init();

                var dateArray = startingDate.split("-");
                $("#datepicker").datepicker({
                  defaultDate : new Date(dateArray[0], dateArray[1] - 1, dateArray[2]),
                  minDate : new Date(2014, 0),
                  onSelect : selectDay,
                  beforeShowDay : highlightDays
                });

              }
            },
            error: function() {
              console.log("Error fetching breathecam.json")
            }
          });
        });
      </script>
    </head>
  <body>
    <div id="player1" style="position: absolute; top:10px; left:10px;"></div>
    <div id="datepicker" style="position: absolute; top:10px; left:1090px;"></div>
  </body>
</html>
