<!DOCTYPE html>
<html>
  <head>
    <title>Mon Valley Cameras</title>
    <meta content='text/html; charset=UTF-8' http-equiv='Content-Type' />

    <meta property="og:title" content="Mon Valley Cameras" />
    <meta property="og:url" content="https://mon.createlab.org" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://mon.createlab.org/assets/images/collage.png" />
    <meta property="fb:app_id" content="342963495886660" />

    <meta name="twitter:card" content="summary" />

    <link href="assets/stylesheets/breathecam.css" media="all" rel="stylesheet" type="text/css" />
    <link href="timemachine-viewer/css/jquery-ui/smoothness/jquery-ui.custom.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="timemachine-viewer/css/defaultUI.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="timemachine-viewer/libs/change-detect/css/change.css" media="screen" rel="stylesheet" type="text/css" />

    <script src="timemachine-viewer/js/jquery/jquery.min.js" type="text/javascript"></script>
    <script src="timemachine-viewer/js/jquery/jquery-ui.custom.min.js" type="text/javascript"></script>
    <script src="timemachine-viewer/js/jquery/plugins/mouse/jquery.mousewheel.min.js" type="text/javascript"></script>
    <script src="timemachine-viewer/js/jquery/plugins/dialogExtend/jquery.dialogextend.min.js" type="text/javascript"></script>
    <script src="timemachine-viewer/js/downloadjs/download.min.js"></script>
    <script src="timemachine-viewer/js/org/gigapan/util.js" type="text/javascript"></script>
    <script src="timemachine-viewer/js/org/gigapan/timelapse/videoset.js" type="text/javascript"></script>
    <script src="timemachine-viewer/js/org/gigapan/timelapse/parabolicMotion.js" type="text/javascript"></script>
    <script src="timemachine-viewer/js/org/gigapan/timelapse/timelapse.js" type="text/javascript"></script>
    <script src="timemachine-viewer/js/Math.uuid.js" type="text/javascript"></script>
    <script src="timemachine-viewer/js/org/gigapan/timelapse/snaplapse.js" type="text/javascript"></script>
    <script src="timemachine-viewer/js/org/gigapan/timelapse/snaplapseViewer.js" type="text/javascript"></script>
    <script src="timemachine-viewer/js/org/gigapan/timelapse/defaultUI.js" type="text/javascript"></script>
    <script src="timemachine-viewer/js/org/gigapan/timelapse/crossdomain_api.js" type="text/javascript"></script>
    <script src="timemachine-viewer/template_includes.js" type="text/javascript"></script>
    <script src="extras/jquery.xdomainrequest.min.js" type="text/javascript"></script>
    <script src="timemachine-viewer/js/canvasjs/canvasjs.min.js" type="text/javascript"></script>
    <script src="timemachine-viewer/libs/change-detect/js/ThumbnailServiceAPI.js" type="text/javascript"></script>
    <script src="timemachine-viewer/libs/change-detect/js/TimeMachineCanvasLayer.js" type="text/javascript"></script>
    <script src="timemachine-viewer/libs/change-detect/js/ThumbnailTool.js" type="text/javascript"></script>
    <script src="timemachine-viewer/libs/change-detect/js/BoxEventHandler.js" type="text/javascript"></script>
    <script src="timemachine-viewer/libs/change-detect/js/ChangeDetectionTool.js" type="text/javascript"></script>
    <script src="https://tiles.cmucreatelab.org/ecam/timemachines/clairton1/clairton1.js" type="text/javascript"></script>
    <style type="text/css">
      #timeMachine {
        position: fixed;
        left: 0px;
        right: 226px;
        top: 0px;
        width: auto;
        height: 100%;
        z-index: 5;
      }
      #datepicker {
        right: 0px !important;
      }
      #datepicker .ui-datepicker-next, #datepicker .ui-datepicker-prev {
        cursor: pointer;
      }
      #datepicker .ui-datepicker-header {
        color: white;
        background: rgb(150, 150, 150);
        border: 0px solid rgb(204, 204, 204);
        border-radius: 3px !important;
        box-shadow: 0px 0px 10px rgba(0,0,0,0.5);
      }
      #datepicker .ui-datepicker {
        font-size: 12px;
        height: 190px;
        border-radius: 0;
        color: #555555;
        background: rgb(248, 248, 248);
        border: 1px solid rgb(150, 150, 150);
      }
      #datepicker .ui-state-default {
        background: rgb(150, 150, 150);
        border-radius: 3px !important;
        color: white;
        box-shadow: 0px 0px 0px rgba(0,0,0,0.5);
      }
      #datepicker .ui-state-hover {
        background: rgb(100, 100, 100) !important;
      }
      #datepicker .date-highlight a {
        color: white;
        background: rgb(150, 150, 150);
        border: 1px solid rgb(204, 204, 204);
      }
      #datepicker .ui-state-active {
        border: 1px solid rgb(204, 204, 204) !important;
        background: #2794DD !important;
        box-shadow: 0px 0px 10px rgba(0,0,0,0.5);
      }
      #datepicker .ui-datepicker-header .ui-icon {
        background-image: url('assets/images/ui-icons_custom_256x240.png');
      }
      .ui-dialog {
        text-align: left;
      }
    </style>
    <script>
      "use strict"
      jQuery.support.cors = true;
      var locationDivId, timelapse, timelapseFeedUnavailable, hashVars, currentDate;
      var currentLocation = "clairton1";
      var locationMap = {
        "heinz" : "North Shore",
        "trimont" : "Downtown",
        "walnuttowers1" : "Mon Valley",
        "pitt1" : "Oakland",
        "clairton1" : "Clairton",
        "walnuttowers2" : "Edgar Thomson",
        "braddock1" : "Edgar Thomson",
        "dravosburg2" : "Irvin",
        "westmifflin1" : "Edgar Thomson"
      };
      function tm_init() {
        var initialDataset = cached_breathecam.latest.path;
        var startingDate = cached_breathecam.latest.date;
        var hash = window.location.hash.slice(1);
        hashVars = org.gigapan.Util.unpackVars(hash);
        var loadedTimelapse = false;
        if (hashVars) {
          if (hashVars.d) {
            startingDate = String(hashVars.d);
            initialDataset = cached_breathecam.datasets[startingDate];
            if (!initialDataset) {
              initialDataset = cached_breathecam.latest.path;
            }
          }
          if (hashVars.s) {
            loadedTimelapse = true;
            currentLocation = String(hashVars.s);
            changeLocation(currentLocation, startingDate, null, null, false, function() {
              initialDataset = cached_breathecam.datasets[startingDate];
              if (!initialDataset) {
                initialDataset = cached_breathecam.latest.path;
              }
              setupTimelapse(initialDataset, startingDate);
            });
          }
        }
        locationDivId = currentLocation + "_overlay";
        setLocationThumbnailToggle();
        selectTimelapseFeed();
        // If we did not load the timelapse with the hash vars above, do so now.
        if (!loadedTimelapse)
          setupTimelapse(initialDataset, startingDate);
      }
      function setupTimelapse(initialDataset, startingDate) {
        initialDataset = initialDataset.replace("http:", "https:");
        var settings = {
          url: initialDataset,
          disableTourLooping: true,
          mediaType: ".mp4",
          showFullScreenBtn: true,
          showLogoOnDefaultUI: false,
          showThumbnailTool: true,
          enableChangeDetection: false,
          datasetType: "breathecam",
          socialMedia: {
            twitterHandle: "BreatheProject",
            facebookAppId: "342963495886660",
            hashTags: ["BreatheCam"]
          },
          onTimeMachinePlayerReady: function(viewerDivId) {
            // Move to inside timeMachine div so it does not overlap share view box
            $("#locationTitle").appendTo("#timeMachine .player");
            // set 'Fast' to 4x, 'Medium' to 2x and 'Slow' to 1x
            timelapse.setMasterPlaybackRate(4);
            timelapse.setPlaybackRate(1);
            // Set thumbnail export default playback rate to 'Slow' since that's default speed
            $(".thumbnail-playback-rate-menu").children().first().click();
            // Override the hashchange event
            window.onhashchange = null;
            $(window).on("hashchange", function() {
              var newHash = window.location.hash.slice(1);
              var newHashVars = org.gigapan.Util.unpackVars(newHash);
              var currentHash = timelapse.getShareView();
              var currentHashVars = org.gigapan.Util.unpackVars(currentHash);
              window.location.hash = "";
              if (!newHashVars) return;
              if ((newHashVars.d && currentHashVars.d != newHashVars.d) || (newHashVars.s && currentHashVars.s != newHashVars.s)) {
                var newDate, newDataset;
                if (newHashVars.d) {
                  newDate = String(newHashVars.d);
                  newDataset = cached_breathecam.datasets[newDate];
                  if (!newDataset) return;
                }
                var newTime = parseFloat(newHashVars.t);
                var newView = timelapse.normalizeView(timelapse.unsafeViewToView(newHashVars.v));
                if (newHashVars.s && currentHashVars.s != newHashVars.s) {
                  currentLocation = String(newHashVars.s);
                  changeLocation(currentLocation, newDate, newView, newTime, true);
                } else {
                  updateCalendarAndToggleUI(newDate);
                  newDataset = newDataset.replace("http:", "https:");
                  timelapse.loadTimelapse(newDataset, newView, newTime, false);
                }
              } else {
                // Share views
                timelapse.loadSharedViewFromUnsafeURL(org.gigapan.Util.getUnsafeHashString());
              }
            });
            /*if (hashVars && !hashVars.t) {
              var numFrames = timelapse.getNumFrames();
              // 12 fps * 5 seconds = 60 frames
              var fiveSecondsFromEnd = numFrames - 60;
              timelapse.seekToFrame(fiveSecondsFromEnd);
            }*/
            showContent();
            var du = timelapse.getDefaultUI()
            if (du) {
              du.addEventListener('thumbnail-generated-from-ui', function(thumbnailParams) {
                $.ajax({
                  type: "POST",
                  dataType: "json",
                  url: "https://breathecam.cmucreatelab.org/camera_findings",
                  data: {
                    camera_finding: {
                      camera_id : thumbnailParams.timemachineId,
                      camera_name : locationMap[thumbnailParams.timemachineId],
                      timemachine_path : thumbnailParams.root,
                      media_path : thumbnailParams.url,
                      media_format : thumbnailParams.format,
                      media_width : thumbnailParams.width,
                      media_height : thumbnailParams.height,
                      comment : $("#camera-findings-comment").val(),
                      begin_time : thumbnailParams.beginTime,
                      end_time : thumbnailParams.endTime,
                      start_frame : thumbnailParams.startFrame,
                      num_frames : thumbnailParams.nframes
                    }
                  }
                });
              });
            }
            var lastThumbnailToolRow = $(".generate-thumbnail").closest("tr");
            $("<tr><td>Comments:</td><td><textarea id='camera-findings-comment' rows='4' cols='21' placeholder='Optionally enter any comments about what you found.'></textarea></td></tr>").insertBefore(lastThumbnailToolRow);
          }
        };
        timelapse = new org.gigapan.timelapse.Timelapse("timeMachine", settings);
        loadCalendar(startingDate);
      }

      function selectTimelapseFeed() {
        $("#image_feed").css("visibility", "hidden");
        $("#stitched_image_wrapper").css("visibility", "hidden");
        $("#stitched_image").css("visibility", "hidden");
        $("#timelapse_feed").show();
        setLocationTitle();
      }
      function selectImageFeed() {
        $("#timelapse_feed").hide();
        $("#image_feed").css("visibility", "visible");
        $("#stitched_image_wrapper").css("visibility", "visible");
        $("#stitched_image").css("visibilriity", "visible");
        $("#location_toggle_container").css("top", "0px");
        setLocationTitle();
      }
      function setLocationTitle() {
        var locationTitle = $("#location_toggle .location_thumbnail_selected").siblings(".location_title").text();
        $("#locationTitle").text(locationTitle);
      }
      function showContent() {
        $("#loading").hide();
        $("#content").css("visibility", "visible");
        $("#location_toggle").scrollTop($("#" + locationDivId).offset().top - $("#location_toggle").offset().top);
      }
      function changeLocation(locationName, newDate, newView, newTime, doLoad, callBack, newTimeAsDateObj) {
        currentLocation = locationName;
        if (timelapseFeedUnavailable) {
          location.href = "/embeds/" + locationName;
        } else {
          $.ajax({
            url: "https://tiles.cmucreatelab.org/ecam/timemachines/" + locationName + "/" + locationName + ".json",
            dataType: "json"
          }).done(function(data) {
            cached_breathecam = data;
            var startingDate = cached_breathecam.latest.date;
            var startingDataset = cached_breathecam.latest.path;
            if (newDate) {
              var tmpStartingDataset = cached_breathecam.datasets[newDate];
              if (tmpStartingDataset) {
                startingDate = newDate;
                startingDataset = tmpStartingDataset;
              }
            }
            // If there is no timelapse object at this point, then that means that we have just arrived at the page
            // with a share link that has an invalid location name.
            // Load the timelapse with the default location specified in the .fail() callback below.
            if (!timelapse) {
              setupTimelapse(startingDataset, startingDate);
              return;
            }
            updateCalendarAndToggleUI(startingDate);
            if (doLoad) {
              if (timelapse && startingDataset) {
                newTime = parseFloat(newTime);
                startingDataset = startingDataset.replace("http:", "https:");
                timelapse.loadTimelapse(startingDataset, newView, newTime, false, newTimeAsDateObj, function() {
                  if (!newTimeAsDateObj && isNaN(newTime)) {
                    var numFrames = timelapse.getNumFrames();
                    // 12 fps * 5 seconds = 60 frames
                    var fiveSecondsFromEnd = numFrames - 60;
                    timelapse.seekToFrame(fiveSecondsFromEnd);
                  }
                });
              }
            } else if (typeof(callBack) === "function") {
              callBack();
            }
          }).fail(function(jqXHR, textStatus, errorThrown) {
            console.log(jqXHR, textStatus, errorThrown);
            changeLocation("heinz", null, null, null, true);
          });
        }
      }
      function updateCalendarAndToggleUI(startingDate) {
        locationDivId = currentLocation + "_overlay";
        setLocationThumbnailToggle();
        setLocationTitle();
        $("#datepicker").datepicker("destroy");
        loadCalendar(startingDate);
      }
      function loadCalendar(startingDate) {
        currentDate = startingDate;
        var dateArray = startingDate.split("-");
        $("#datepicker").datepicker({
          defaultDate : new Date(dateArray[0], dateArray[1] - 1, dateArray[2]),
          minDate : new Date(2014, 0),
          onSelect : selectDay,
          beforeShowDay : highlightDays
        });
      }
      function highlightDays(date) {
        date = $.datepicker.formatDate('yy-mm-dd', date);
        if (cached_breathecam.datasets[date])
          return [true, 'date-highlight'];
        else
          return [false, ''];
      }
      function selectDay(dateText, dateElem) {
        var wasPaused = timelapse.isPaused();
        timelapse.pause();
        var date = $.datepicker.formatDate('yy-mm-dd', new Date(dateText));
        var path = cached_breathecam.datasets[date];
        if (timelapse && path) {
          currentDate = date;
          path = path.replace("http:", "https:");
          timelapse.loadTimelapse(path, null, null, true);
        }
        if (!wasPaused) {
          timelapse.handlePlayPause();
        }
      }
      function setLocationThumbnailToggle() {
        $(".location_thumbnail_selected").removeClass("location_thumbnail_selected");
        $("#" + locationDivId).addClass("location_thumbnail_selected");
      }
      $(function() {
        $(".location_thumbnail_container").on("click", function() {
          if (window.location.hash)
            window.location.hash = "";
          var newLocation = $(this).attr("data-location-id");
          if (timelapse)
            var captureTimeAsDateObj = new Date(timelapse.getCurrentCaptureTime().replace(/-/g,"/"));
          changeLocation(newLocation, currentDate, null, null, true, null, captureTimeAsDateObj);
        });
        tm_init();
        $("#container").on("mousedown", function() { return false; });
      });
    </script>
  </head>
  <div id="loading">
    <img id="loadingImg" src="assets/images/loading.gif" width="508" height="381" alt="loading">
  </div>
  <div id="locationTitle"></div>
  <div id="timelapse_feed" class="timelapse_feed_embed">
    <div id="timeMachine"></div>
    <div id="datepicker" class="datepicker_embed"></div>
  </div>
  <div id="location_toggle_container">
    <div id="location_toggle">
      <a class="location_thumbnail_container" data-location-id="clairton1" href="javascript:void(0)">
        <div id="clairton1_overlay" class="location_thumbnail_overlay"></div>
        <img src="assets/images/clairton1_toggle.png" class="location_thumbnail" alt="Clairton1">
        <div class="location_title">Clairton</div>
      </a>
      <a class="location_thumbnail_container" data-location-id="walnuttowers2" href="javascript:void(0)">
        <div id="walnuttowers2_overlay" class="location_thumbnail_overlay"></div>
        <img src="assets/images/walnuttowers2_toggle.png" class="location_thumbnail" alt="walnuttowers2">
        <div class="location_title">Edgar Thomson West</div>
      </a>
      <a class="location_thumbnail_container" data-location-id="braddock1" href="javascript:void(0)">
        <div id="braddock1_overlay" class="location_thumbnail_overlay"></div>
        <img src="assets/images/braddock1_toggle.png" class="location_thumbnail" alt="braddock1">
        <div class="location_title">Edgar Thomson North</div>
      </a>
      <a class="location_thumbnail_container" data-location-id="westmifflin1" href="javascript:void(0)">
        <div id="westmifflin1_overlay" class="location_thumbnail_overlay"></div>
        <img src="assets/images/westmifflin1_toggle.png" class="location_thumbnail" alt="westmifflin1">
        <div class="location_title">Edgar Thomson South</div>
      </a>
      <a class="location_thumbnail_container" data-location-id="dravosburg2" href="javascript:void(0)">
        <div id="dravosburg2_overlay" class="location_thumbnail_overlay"></div>
        <img src="assets/images/dravosburg2_toggle.png" class="location_thumbnail" alt="dravosburg2">
        <div class="location_title">Irvin</div>
      </a>
      <a class="location_thumbnail_container" data-location-id="heinz" href="javascript:void(0)">
        <div id="heinz_overlay" class="location_thumbnail_overlay"></div>
        <img src="assets/images/heinz_toggle.png" class="location_thumbnail" alt="Heinz">
        <div class="location_title">North Shore</div>
      </a>
      <a class="location_thumbnail_container" data-location-id="trimont1" href="javascript:void(0)">
        <div id="trimont1_overlay" class="location_thumbnail_overlay"></div>
        <img src="assets/images/trimont1_toggle.png" class="location_thumbnail" alt="Trimont">
        <div class="location_title">Downtown</div>
      </a>
      <a class="location_thumbnail_container" data-location-id="walnuttowers1" href="javascript:void(0)">
        <div id="walnuttowers1_overlay" class="location_thumbnail_overlay"></div>
        <img src="assets/images/walnuttowers1_toggle.png" class="location_thumbnail" alt="Walnut Towers">
        <div class="location_title">Mon. Valley</div>
      </a>
      <a class="location_thumbnail_container location_thumbnail_container_end" data-location-id="pitt1" href="javascript:void(0)">
        <div id="pitt1_overlay" class="location_thumbnail_overlay"></div>
        <img src="assets/images/pitt1_toggle.png" class="location_thumbnail" alt="Pitt">
        <div class="location_title">Oakland</div>
      </a>
    </div>
  </div>
</html>
